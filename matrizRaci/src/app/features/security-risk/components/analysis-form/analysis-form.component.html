<div class="form-container">
  <div class="form-header">
    <h2>{{ isEditMode ? '‚úèÔ∏è Editar An√°lise de Seguran√ßa' : 'üõ°Ô∏è Nova An√°lise de Seguran√ßa' }}</h2>
    <p class="subtitle">Cadastro de an√°lise de risco por User Story ‚Äî Sistema Financeiro</p>
  </div>

  <form [formGroup]="form" (ngSubmit)="submit()" novalidate>

    <!-- ‚îÄ‚îÄ SE√á√ÉO 1: Dados da User Story ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <section class="form-section">
      <h3>üìã User Story</h3>
      <div class="form-row">
        <div class="form-group">
          <label>ID da User Story *</label>
          <input formControlName="userStoryId" placeholder="Ex: US-4521" />
          <span class="error" *ngIf="hasError('userStoryId', 'required')">Campo obrigat√≥rio</span>
          <span class="error" *ngIf="hasError('userStoryId', 'pattern')">Formato: US-[n√∫mero] (ex: US-1234)</span>
        </div>
        <div class="form-group">
          <label>Nome da Funcionalidade *</label>
          <input formControlName="featureName" placeholder="Ex: Transfer√™ncia PIX" />
          <span class="error" *ngIf="hasError('featureName', 'required')">Campo obrigat√≥rio</span>
        </div>
        <div class="form-group">
          <label>Sprint *</label>
          <input formControlName="sprint" placeholder="Ex: Sprint 15" />
          <span class="error" *ngIf="hasError('sprint', 'required')">Campo obrigat√≥rio</span>
        </div>
      </div>

      <div class="form-group">
        <label>Sistemas Impactados *</label>
        <div class="checkbox-group">
          @for (sys of systemOptions; track sys) {
            <label class="checkbox-label">
              <input type="checkbox"
                     [checked]="isSystemSelected(sys)"
                     (change)="onSystemToggle(sys, $any($event.target).checked)" />
              {{ sys }}
            </label>
          }
        </div>
        <span class="error" *ngIf="form.get('systemsImpacted')?.touched && !form.get('systemsImpacted')?.value?.length">
          Selecione ao menos um sistema
        </span>
      </div>
    </section>

    <!-- ‚îÄ‚îÄ SE√á√ÉO 2: API REST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <section class="form-section">
      <h3>üîå Endpoint REST</h3>
      <div class="form-row">
        <div class="form-group flex-grow">
          <label>Endpoint *</label>
          <input formControlName="endpoint" placeholder="Ex: /api/v1/pix/transfer" />
          <span class="error" *ngIf="hasError('endpoint', 'required')">Campo obrigat√≥rio</span>
          <span class="error" *ngIf="hasError('endpoint', 'pattern')">Deve iniciar com '/'</span>
        </div>
        <div class="form-group">
          <label>M√©todo HTTP *</label>
          <select formControlName="method">
            @for (m of methodOptions; track m) {
              <option [value]="m">{{ m }}</option>
            }
          </select>
        </div>
        <div class="form-group">
          <label>Sensibilidade dos Dados *</label>
          <select formControlName="dataSensitivity">
            @for (s of sensitOptions; track s) {
              <option [value]="s">{{ s }}</option>
            }
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Tipo de Autentica√ß√£o</label>
          <select formControlName="authType">
            @for (a of authOptions; track a) {
              <option [value]="a">{{ a }}</option>
            }
          </select>
        </div>
        <div class="toggle-group">
          <label class="toggle-label">
            <input type="checkbox" formControlName="requiresAuth" />
            <span>Possui Autentica√ß√£o?</span>
          </label>
          <label class="toggle-label">
            <input type="checkbox" formControlName="requiresRoleAuthorization" />
            <span>Autoriza√ß√£o por Perfil?</span>
          </label>
          <label class="toggle-label highlight-financial">
            <input type="checkbox" formControlName="movesFinancialValue" />
            <span>üí∞ Movimenta Valor Financeiro?</span>
          </label>
        </div>
      </div>
    </section>

    <!-- ‚îÄ‚îÄ SE√á√ÉO 3: Integra√ß√£o MQ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <section class="form-section mq-section">
      <h3>üì® Integra√ß√£o Fila MQ ‚Üí Mainframe</h3>
      <div class="mq-grid">
        <label class="toggle-label">
          <input type="checkbox" formControlName="checksMessageIntegrity" />
          <span>Verifica Integridade da Mensagem (HMAC/Assinatura)</span>
        </label>
        <label class="toggle-label">
          <input type="checkbox" formControlName="checksSchemaOnMainframeEntry" />
          <span>Valida√ß√£o de Schema na Entrada do Mainframe</span>
        </label>
        <label class="toggle-label">
          <input type="checkbox" formControlName="hasIdempotencyKey" />
          <span>Possui Chave de Idempot√™ncia</span>
        </label>
        <label class="toggle-label">
          <input type="checkbox" formControlName="hasReplayProtection" />
          <span>Prote√ß√£o contra Replay Attack</span>
        </label>
        <label class="toggle-label">
          <input type="checkbox" formControlName="hasDeadLetterQueue" />
          <span>Dead Letter Queue Configurada</span>
        </label>
      </div>
    </section>

    <!-- ‚îÄ‚îÄ SE√á√ÉO 4: Extras Estrat√©gicos ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <section class="form-section strategic-section">
      <h3>üéØ Extras Estrat√©gicos</h3>
      <div class="toggle-row">
        <label class="toggle-label badge-debt">
          <input type="checkbox" formControlName="hasSecurityDebt" />
          <span>üè¶ Security Debt</span>
        </label>
        <label class="toggle-label badge-pentest">
          <input type="checkbox" formControlName="requiresPentest" />
          <span>üîç Requer Pentest?</span>
        </label>
        <label class="toggle-label badge-threat">
          <input type="checkbox" formControlName="requiresThreatModeling" />
          <span>üß† Requer Threat Modeling?</span>
        </label>
      </div>
      <div class="form-group mt-2">
        <label>Observa√ß√µes</label>
        <textarea formControlName="notes" rows="3"
          placeholder="Contexto adicional, decis√µes de arquitetura, depend√™ncias..."></textarea>
      </div>
    </section>

    <!-- ‚îÄ‚îÄ A√á√ïES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="form-actions">
      <button type="button" class="btn-secondary" (click)="cancel()" [disabled]="isSaving">
        Cancelar
      </button>
      <button type="submit" class="btn-primary" [disabled]="isSaving">
        {{ isSaving ? 'Salvando...' : (isEditMode ? 'Atualizar' : 'üõ°Ô∏è Criar An√°lise') }}
      </button>
    </div>
  </form>
</div>
